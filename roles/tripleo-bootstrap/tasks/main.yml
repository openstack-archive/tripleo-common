---

- name: Deploy required packages to bootstrap TripleO
  yum:
    name: "{{ packages_bootstrap }}"
  become: true
  ignore_errors: true

- name: Check required packages are installed
  command:
    rpm -q {{ item }}
  with_items: "{{ packages_bootstrap }}"

- name: Check NetworkManager status
  shell: systemctl is-active NetworkManager.service || systemctl is-enabled NetworkManager.service
  failed_when: false
  become: true
  register: network_manager_enabled

- name: Stop NetworkManager from updating resolv.conf
  become: true
  when:
    - network_manager_enabled.rc is defined
    - network_manager_enabled.rc == 0
  block:
    - name: Set 'dns=none' in /etc/NetworkManager/NetworkManager.conf
      ini_file:
        path: /etc/NetworkManager/NetworkManager.conf
        state: present
        no_extra_spaces: true
        section: main
        option: dns
        value: none
        backup: true
    - name: Reload NetworkManager
      service:
        name: NetworkManager
        state: reloaded

- name: Create /var/lib/heat-config/tripleo-config-download directory for deployment data
  file:
    path: /var/lib/heat-config/tripleo-config-download
    state: directory
  become: true
