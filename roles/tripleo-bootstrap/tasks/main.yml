---

- name: Deploy required packages to bootstrap TripleO
  yum:
    name: "{{ packages_bootstrap }}"
  become: true
  ignore_errors: true

- name: Check required packages are installed
  command:
    rpm -q {{ item }}
  with_items: "{{ packages_bootstrap }}"

- name: Populate service facts
  service_facts:

- name: Stop NetworkManager from updating resolv.conf
  become: true
  when:
    - ansible_os_family | lower == 'redhat'
    - ansible_distribution_major_version | int >= 7
    - "'NetworkManager.service' in ansible_facts.services"
    - ansible_facts.services['NetworkManager.service']['status'] == 'enabled'
  block:
    - name: Set 'dns=none' in /etc/NetworkManager/NetworkManager.conf
      ini_file:
        path: /etc/NetworkManager/NetworkManager.conf
        state: present
        no_extra_spaces: true
        section: main
        option: dns
        value: none
        backup: true
    - name: Reload NetworkManager
      service:
        name: NetworkManager
        state: reloaded

- name: Create /var/lib/heat-config/tripleo-config-download directory for deployment data
  file:
    path: /var/lib/heat-config/tripleo-config-download
    state: directory
  become: true
